<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.care.library.search.SearchMapper">
	<resultMap type="com.care.library.search.BookDTO"
		id="bookDto"> <!-- id는 식별자일뿐 -->
		<result column="publication_year" property="publicationYear" />
	</resultMap>

	<select id = "findMaxNum">
  		SELECT MAX(book_id) FROM totalBook
  	</select>
  	
	<!-- 검색 전 모든 책 보여주기 -->
	<select id="getTotal" resultMap="bookDto">
		SELECT A.* FROM (SELECT * FROM totalBook ORDER BY book_id ASC)A WHERE A.book_id BETWEEN #{begin} AND #{end}
	</select>


	<insert id="popularInsert"
		parameterType="com.care.library.search.BookDTO">
		INSERT INTO popularBook VALUES(#{no}, #{ranking},
		#{publicationYear},#{bookName}, #{authors}, #{publisher},
		#{bookImageURL}, #{vol, jdbcType=VARCHAR}, #{isbn})
	</insert>

	<insert id="recentInsert"
		parameterType="com.care.library.search.BookDTO">
		INSERT INTO recentBook VALUES(#{bookName}, #{authors},
		#{publisher}, #{bookImageURL}, #{publicationYear}, #{vol,
		jdbcType=VARCHAR}, #{isbn})
	</insert>

	<insert id="insertTotal"
		parameterType="com.care.library.search.BookDTO">
		INSERT INTO totalBook (bookName, authors, publisher,
		bookImageURL, publication_year ,vol, isbn, rest_vol) VALUES(#{bookName},#{authors},
		#{publisher}, #{bookImageURL}, #{publicationYear}, #{vol,
		jdbcType=VARCHAR}, #{isbn}, #{vol, jdbcType=VARCHAR})
	</insert>

	<delete id="deleteData">
		<if test="whichTable == 'popularBook'">
			DELETE FROM popularBook
		</if>
		<if test="whichTable == 'recentBook'">
			DELETE FROM recentBook
		</if>
		<if test="whichTable == 'totalBook'">
			DELETE FROM totalBook
		</if>
	</delete>

	<select id="getBookImages">
		<if test="whichTable == 'popularBook'">
			<!-- SELECT bookImageURL FROM popularBook WHERE no <![CDATA[ <= ]]> 5 -->
			SELECT bookImageURL FROM (SELECT bookImageURL, ROWNUM AS rn FROM
			popularBook ORDER BY TO_NUMBER(ranking) ASC)A WHERE A.rn <![CDATA[ <= ]]>
			5
		</if>
		<if test="whichTable == 'recentBook'">
			SELECT bookImageURL FROM recentBook
		</if>
	</select>

	<!-- 대여하기 -->
	<!-- 관리자 테이블에 들어가야겠지 -->

	<select id="checkTotalDB">
		SELECT COUNT(*) FROM totalBook
	</select>

	<select id="checkSearchCount">
		SELECT COUNT(A.id) FROM (SELECT book_id AS id FROM totalBook WHERE
		LOWER(bookName) LIKE LOWER('%'||#{search}||'%'))A
	</select>

	<select id="getTable" resultMap="bookDto">
		<if test="whichTable == 'popularBook'">
			<!-- SELECT bookImageURL FROM popularBook WHERE no <![CDATA[ <= ]]> 5 -->
			SELECT * FROM popularBook
		</if>
		<if test="whichTable == 'recentBook'">
			SELECT * FROM recentBook
		</if>
	</select>

	<!--통합검색 -->
	<select id="totalSearch" resultMap="bookDto">
  		SELECT BBB.* FROM(SELECT ROWNUM as rn, AAA.* FROM(SELECT * FROM totalBook WHERE LOWER(bookName) LIKE LOWER('%'||#{search}||'%') ORDER BY book_id ASC)AAA)BBB WHERE rn BETWEEN #{begin} AND #{end}
	</select>
	
	
	<resultMap type="com.care.library.search.BookLoanDTO" id="bookLoanDto"> <!-- id는 식별자일뿐 -->
		<result column="user_id" property="userId" />
		<result column="start_date" property="startDate" />
		<result column="end_date" property="endDate" />
	</resultMap>
	
	<!-- 대출 신청 -->
	<insert id="insertLoan" parameterType="com.care.library.search.BookLoanDTO">
		INSERT INTO bookLoan (user_id, bookName, isbn, start_date, end_date) 
		values(#{userId}, #{bookName}, #{isbn}, #{startDate}, #{endDate})
	</insert>
	
	<!-- isbn으로 대출한 책 권수 찾기 -->
	<select id="checkRestVol">
		SELECT count(rest_vol) FROM totalBook WHERE isbn=#{isbn}
	</select>
</mapper>







  